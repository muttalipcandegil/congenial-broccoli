name: Setup RustDesk on Windows Runner

on:
  workflow_dispatch:  # Manuel tetikleme iÃ§in

jobs:
  setup-rustdesk:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download RustDesk
      run: |
        # En son RustDesk sÃ¼rÃ¼mÃ¼nÃ¼ indir
        $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/rustdesk/rustdesk/releases/latest"
        $downloadUrl = $latestRelease.assets | Where-Object { $_.name -like "*x86_64.exe" } | Select-Object -First 1
        Invoke-WebRequest -Uri $downloadUrl.browser_download_url -OutFile "rustdesk-installer.exe"
        Write-Host "RustDesk indirildi: $($downloadUrl.name)"

    - name: Generate secure random password
      id: generate-password
      run: |
        # GÃ¼venli rastgele ÅŸifre oluÅŸtur (16 karakter: harf, sayÄ±, Ã¶zel karakter)
        $chars = @()
        $chars += [char[]](65..90)   # BÃ¼yÃ¼k harf
        $chars += [char[]](97..122)  # KÃ¼Ã§Ã¼k harf
        $chars += [char[]](48..57)   # SayÄ±lar
        $chars += [char[]]('!@#$%^&*'.ToCharArray())  # Ã–zel karakterler
        
        $password = -join ($chars | Get-Random -Count 16)
        Write-Host "OluÅŸturulan ÅŸifre: $password"
        Write-Output "PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Install RustDesk with random password
      run: |
        # Sessiz kurulum ve rastgele ÅŸifre ayarÄ±
        Write-Host "RustDesk kurulumu baÅŸlatÄ±lÄ±yor..."
        Start-Process -FilePath ".\rustdesk-installer.exe" -ArgumentList "--silent-install", "--password", "$env:PASSWORD" -Wait
        
        # Kurulumun tamamlanmasÄ±nÄ± bekle
        Start-Sleep -Seconds 10
        Write-Host "RustDesk kurulumu tamamlandÄ±"

    - name: Get RustDesk ID
      run: |
        # RustDesk ID'sini al
        Start-Sleep -Seconds 5  # Servisin baÅŸlamasÄ± iÃ§in bekle
        
        # RustDesk executable'Ä±nÄ± bul ve ID'yi al
        $rustdeskPaths = @(
            "$env:ProgramFiles\RustDesk\rustdesk.exe",
            "${env:ProgramFiles(x86)}\RustDesk\rustdesk.exe",
            "$env:LOCALAPPDATA\Programs\RustDesk\rustdesk.exe"
        )
        
        foreach ($path in $rustdeskPaths) {
            if (Test-Path $path) {
                Write-Host "RustDesk bulundu: $path"
                $id = & $path --get-id
                Write-Host "RustDesk ID: $id"
                Write-Output "RUSTDESK_ID=$id" | Out-File -FilePath $env:GITHUB_ENV -Append
                break
            }
        }
        
        if (-not $env:RUSTDESK_ID) {
            Write-Host "âŒ RustDesk ID alÄ±namadÄ±"
        }

    - name: Start RustDesk Service
      run: |
        # RustDesk servisini baÅŸlat
        Start-Service -Name "RustDesk" -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 3
        
        # Servis durumunu kontrol et
        $service = Get-Service -Name "RustDesk" -ErrorAction SilentlyContinue
        if ($service -and $service.Status -eq "Running") {
            Write-Host "âœ… RustDesk servisi Ã§alÄ±ÅŸÄ±yor"
        } else {
            Write-Host "âš ï¸ RustDesk servisi baÅŸlatÄ±lamadÄ±, process olarak baÅŸlatÄ±lÄ±yor..."
            if (Test-Path "$env:ProgramFiles\RustDesk\rustdesk.exe") {
                Start-Process -FilePath "$env:ProgramFiles\RustDesk\rustdesk.exe" -WindowStyle Hidden
                Write-Host "âœ… RustDesk process olarak baÅŸlatÄ±ldÄ±"
            }
        }

    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "ğŸš€ RUSTDESK BAÄLANTI BÄ°LGÄ°LERÄ°"
        Write-Host "=========================================="
        Write-Host "ID: $env:RUSTDESK_ID"
        Write-Host "Password: $env:PASSWORD"
        Write-Host "=========================================="
        Write-Host ""
        Write-Host "ğŸ“ Not: Bu bilgileri kullanarak baÄŸlanabilirsiniz"
        Write-Host "ğŸ”’ GÃ¼venlik: Bu bilgileri gÃ¼vende tutun!"
        Write-Host ""

    - name: Verify Installation
      run: |
        # Kurulumu doÄŸrula
        Write-Host "Kurulum doÄŸrulanÄ±yor..."
        
        $success = $true
        
        # Process kontrolÃ¼
        $process = Get-Process rustdesk -ErrorAction SilentlyContinue
        if ($process) {
            Write-Host "âœ… RustDesk process Ã§alÄ±ÅŸÄ±yor"
        } else {
            Write-Host "âŒ RustDesk process Ã§alÄ±ÅŸmÄ±yor"
            $success = $false
        }
        
        # ID kontrolÃ¼
        if ($env:RUSTDESK_ID) {
            Write-Host "âœ… RustDesk ID alÄ±ndÄ±: $env:RUSTDESK_ID"
        } else {
            Write-Host "âŒ RustDesk ID alÄ±namadÄ±"
            $success = $false
        }
        
        # Åifre kontrolÃ¼
        if ($env:PASSWORD) {
            Write-Host "âœ… Åifre ayarlandÄ±"
        } else {
            Write-Host "âŒ Åifre ayarlanamadÄ±"
            $success = $false
        }
        
        if ($success) {
            Write-Host "ğŸ‰ RustDesk kurulumu baÅŸarÄ±lÄ±!"
        } else {
            Write-Host "ğŸ’¥ RustDesk kurulumunda sorunlar var!"
            exit 1
        }
