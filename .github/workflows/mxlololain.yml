name: Install and Monitor RustDesk

on:
  workflow_dispatch:  # Manuel tetikleme
  push:
    branches: [ main, master ]

jobs:
  install-rustdesk-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download RustDesk with Alternative Method
      run: |
        Write-Host "‚¨áÔ∏è Downloading RustDesk with alternative method..."
        
        # GitHub API ile en son release bilgisini al
        $releaseInfo = Invoke-RestMethod -Uri "https://api.github.com/repos/rustdesk/rustdesk/releases/latest"
        $downloadUrl = $releaseInfo.assets | Where-Object { $_.name -like "*Windows-x64.exe" } | Select-Object -First 1
        
        if ($downloadUrl) {
            Write-Host "Found download URL: $($downloadUrl.browser_download_url)"
            $output = "RustDesk-Setup.exe"
            
            # Headers ile indirme
            $headers = @{
                'User-Agent' = 'GitHub-Actions-Workflow'
                'Accept' = 'application/octet-stream'
            }
            
            Invoke-WebRequest -Uri $downloadUrl.browser_download_url -OutFile $output -Headers $headers
            Write-Host "‚úÖ RustDesk downloaded successfully"
        } else {
            Write-Host "‚ùå Could not find download URL"
            exit 1
        }
      
    - name: Silent Install RustDesk
      run: |
        Write-Host "üîÑ Installing RustDesk silently..."
        if (Test-Path ".\RustDesk-Setup.exe") {
            Start-Process -FilePath ".\RustDesk-Setup.exe" -ArgumentList "--silent-install" -Wait -NoNewWindow
            Start-Sleep -Seconds 10
            Write-Host "‚úÖ Installation completed"
        } else {
            Write-Host "‚ùå Installer not found"
            exit 1
        }
      
    - name: Set Custom ID and Password
      run: |
        $customId = "GH" + (Get-Date -Format "yyyyMMddHHmmss")
        $customPassword = "GitHubAction$((Get-Random -Maximum 9999))"
        
        Write-Host "üÜî Setting custom ID: $customId"
        Write-Host "üîí Setting custom password: $customPassword"
        
        # RustDesk'i ba≈ülat ve ID/password ayarla
        $rustdeskPath = "C:\Program Files\RustDesk\RustDesk.exe"
        if (Test-Path $rustdeskPath) {
            Start-Process -FilePath $rustdeskPath -ArgumentList "--set-id", $customId, "--password", $customPassword -WindowStyle Hidden
            Write-Host "‚úÖ RustDesk started with custom credentials"
        } else {
            Write-Host "‚ùå RustDesk not found at $rustdeskPath"
            # Alternatif konumlarƒ± dene
            $alternativePaths = @(
                "$env:PROGRAMFILES\RustDesk\RustDesk.exe",
                "${env:PROGRAMFILES(X86)}\RustDesk\RustDesk.exe",
                "$env:LOCALAPPDATA\Programs\RustDesk\RustDesk.exe"
            )
            
            foreach ($path in $alternativePaths) {
                if (Test-Path $path) {
                    Write-Host "‚úÖ Found RustDesk at: $path"
                    Start-Process -FilePath $path -ArgumentList "--set-id", $customId, "--password", $customPassword -WindowStyle Hidden
                    break
                }
            }
        }
        
        echo "RUSTDESK_ID=$customId" >> $env:GITHUB_ENV
        echo "RUSTDESK_PASSWORD=$customPassword" >> $env:GITHUB_ENV
      
    - name: Wait for RustDesk to Initialize
      run: |
        Write-Host "‚è≥ Waiting for RustDesk to initialize..."
        Start-Sleep -Seconds 10
        
        $processes = Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue
        if ($processes) {
            Write-Host "‚úÖ RustDesk is running with $($processes.Count) processes"
        } else {
            Write-Host "‚ö†Ô∏è RustDesk processes not found, checking alternative names..."
            # Alternatif process isimlerini kontrol et
            $allProcesses = Get-Process | Where-Object { $_.ProcessName -like "*rustdesk*" -or $_.ProcessName -like "*RustDesk*" }
            if ($allProcesses) {
                Write-Host "‚úÖ Found RustDesk processes: $($allProcesses.ProcessName -join ', ')"
            } else {
                Write-Host "‚ùå No RustDesk processes found"
            }
        }
      
    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "üéØ" * 60
        Write-Host "üéØ                 RUSTDESK CONNECTION INFORMATION"
        Write-Host "üéØ" * 60
        Write-Host ""
        Write-Host "üÜî ID: $env:RUSTDESK_ID"
        Write-Host "üîí PASSWORD: $env:RUSTDESK_PASSWORD" 
        Write-Host ""
        Write-Host "üíª PLATFORM: Windows GitHub Actions Runner"
        Write-Host "üïí CREATED: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        Write-Host "üîó CONNECTION INSTRUCTIONS:"
        Write-Host "   1. Open RustDesk on your local machine"
        Write-Host "   2. Enter the ID above in remote ID field"
        Write-Host "   3. Use the password when prompted"
        Write-Host "   4. Click Connect"
        Write-Host ""
        Write-Host "‚ö° QUICK COPY:"
        Write-Host "   ID: $env:RUSTDESK_ID"
        Write-Host "   PASS: $env:RUSTDESK_PASSWORD"
        Write-Host ""
        Write-Host "üéØ" * 60
        Write-Host ""
      
    - name: Infinite Monitoring Loop
      run: |
        Write-Host ""
        Write-Host "üîÑ STARTING INFINITE MONITORING LOOP"
        Write-Host "====================================="
        Write-Host "This will run forever until workflow is manually stopped"
        Write-Host "Press the 'Cancel workflow' button in GitHub to stop"
        Write-Host ""
        
        $counter = 1
        
        while ($true) {
            $randomSeconds = Get-Random -Minimum 30 -Maximum 61  # 30-60 saniye arasƒ±
            $currentTime = Get-Date -Format "HH:mm:ss"
            
            Write-Host ""
            Write-Host "‚è∞ TIME - [$currentTime] ITERATION $counter"
            Write-Host "----------------------------------------"
            Write-Host "üÜî RustDesk ID: $env:RUSTDESK_ID"
            Write-Host "üîí Password: $env:RUSTDESK_PASSWORD"
            Write-Host "üìä Status: ‚úÖ ACTIVE - Waiting for connection..."
            Write-Host "‚è≥ Next update in: $randomSeconds seconds"
            Write-Host "----------------------------------------"
            
            # RustDesk process kontrol√º
            $rustdeskProcesses = Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue
            if (-not $rustdeskProcesses) {
                # Alternatif process arama
                $rustdeskProcesses = Get-Process | Where-Object { $_.ProcessName -like "*rustdesk*" -or $_.ProcessName -like "*RustDesk*" }
            }
            
            if ($rustdeskProcesses) {
                Write-Host "‚úÖ RustDesk Running - $($rustdeskProcesses.Count) processes"
            } else {
                Write-Host "‚ö†Ô∏è RustDesk not running, attempting to start..."
                $rustdeskPaths = @(
                    "C:\Program Files\RustDesk\RustDesk.exe",
                    "$env:PROGRAMFILES\RustDesk\RustDesk.exe",
                    "${env:PROGRAMFILES(X86)}\RustDesk\RustDesk.exe",
                    "$env:LOCALAPPDATA\Programs\RustDesk\RustDesk.exe"
                )
                
                foreach ($path in $rustdeskPaths) {
                    if (Test-Path $path) {
                        Start-Process -FilePath $path -WindowStyle Hidden
                        Write-Host "‚úÖ RustDesk started from: $path"
                        break
                    }
                }
            }
            
            Write-Host "üò¥ Sleeping for $randomSeconds seconds..."
            Start-Sleep -Seconds $randomSeconds
            
            $counter++
        } 
