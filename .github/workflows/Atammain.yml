name: Install and Monitor RustDesk

on:
  workflow_dispatch:  # Manuel tetikleme
  push:
    branches: [ main, master ]

jobs:
  install-rustdesk-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Latest RustDesk
      run: |
        Write-Host "â¬‡ï¸ Downloading RustDesk..."
        $url = "https://github.com/rustdesk/rustdesk/releases/latest/download/RustDesk-Windows-x64.exe"
        $output = "RustDesk-Setup.exe"
        Invoke-WebRequest -Uri $url -OutFile $output -UserAgent "GitHubActions"
        Write-Host "âœ… RustDesk downloaded successfully"
      
    - name: Silent Install RustDesk
      run: |
        Write-Host "ğŸ”„ Installing RustDesk silently..."
        Start-Process -FilePath ".\RustDesk-Setup.exe" -ArgumentList "--silent-install" -Wait -NoNewWindow
        Start-Sleep -Seconds 10
        Write-Host "âœ… Installation completed"
      
    - name: Set Custom ID and Password
      run: |
        $customId = "GH" + (Get-Date -Format "yyyyMMddHHmmss")
        $customPassword = "GitHubAction$((Get-Random -Maximum 9999))"
        
        Write-Host "ğŸ†” Setting custom ID: $customId"
        Write-Host "ğŸ”’ Setting custom password: $customPassword"
        
        Start-Process -FilePath "C:\Program Files\RustDesk\RustDesk.exe" -ArgumentList "--set-id", $customId, "--password", $customPassword -WindowStyle Hidden
        
        echo "RUSTDESK_ID=$customId" >> $env:GITHUB_ENV
        echo "RUSTDESK_PASSWORD=$customPassword" >> $env:GITHUB_ENV
      
    - name: Wait for RustDesk to Initialize
      run: |
        Write-Host "â³ Waiting for RustDesk to initialize..."
        Start-Sleep -Seconds 15
        
        $processes = Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue
        if ($processes) {
            Write-Host "âœ… RustDesk is running with $($processes.Count) processes"
        } else {
            Write-Host "âš ï¸ Starting RustDesk..."
            Start-Process -FilePath "C:\Program Files\RustDesk\RustDesk.exe" -WindowStyle Hidden
            Start-Sleep -Seconds 10
        }
      
    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "ğŸ¯" * 60
        Write-Host "ğŸ¯                 RUSTDESK CONNECTION INFORMATION"
        Write-Host "ğŸ¯" * 60
        Write-Host ""
        Write-Host "ğŸ†” ID: $env:RUSTDESK_ID"
        Write-Host "ğŸ”’ PASSWORD: $env:RUSTDESK_PASSWORD" 
        Write-Host ""
        Write-Host "ğŸ’» PLATFORM: Windows GitHub Actions Runner"
        Write-Host "ğŸ•’ CREATED: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        Write-Host "ğŸ”— CONNECTION INSTRUCTIONS:"
        Write-Host "   1. Open RustDesk on your local machine"
        Write-Host "   2. Enter the ID above in remote ID field"
        Write-Host "   3. Use the password when prompted"
        Write-Host "   4. Click Connect"
        Write-Host ""
        Write-Host "âš¡ QUICK COPY:"
        Write-Host "   ID: $env:RUSTDESK_ID"
        Write-Host "   PASS: $env:RUSTDESK_PASSWORD"
        Write-Host ""
        Write-Host "ğŸ¯" * 60
        Write-Host ""
      
    - name: Infinite Monitoring Loop
      run: |
        Write-Host ""
        Write-Host "ğŸ”„ STARTING INFINITE MONITORING LOOP"
        Write-Host "====================================="
        Write-Host "This will run forever until workflow is manually stopped"
        Write-Host "Press the 'Cancel workflow' button in GitHub to stop"
        Write-Host ""
        
        $counter = 1
        
        while ($true) {
            $randomSeconds = Get-Random -Minimum 30 -Maximum 121  # 30-120 saniye arasÄ±
            $currentTime = Get-Date -Format "HH:mm:ss"
            
            Write-Host ""
            Write-Host "â° TIME - [$currentTime] ITERATION $counter"
            Write-Host "----------------------------------------"
            Write-Host "ğŸ†” RustDesk ID: $env:RUSTDESK_ID"
            Write-Host "ğŸ”’ Password: $env:RUSTDESK_PASSWORD"
            Write-Host "ğŸ“Š Status: âœ… ACTIVE - Waiting for connection..."
            Write-Host "â³ Next update in: $randomSeconds seconds"
            Write-Host "----------------------------------------"
            
            # RustDesk process kontrolÃ¼
            $rustdeskProcesses = Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue
            if ($rustdeskProcesses) {
                Write-Host "âœ… RustDesk Running - $($rustdeskProcesses.Count) processes"
            } else {
                Write-Host "âš ï¸ RustDesk not detected, restarting..."
                Start-Process -FilePath "C:\Program Files\RustDesk\RustDesk.exe" -WindowStyle Hidden
                Write-Host "âœ… RustDesk restarted"
            }
            
            # Sistem bilgileri
            try {
                $cpuUsage = (Get-Counter "\Processor(_Total)\% Processor Time" -SampleInterval 1 -MaxSamples 1).CounterSamples.CookedValue
                $memoryUsage = [math]::Round((Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory / 1MB, 2)
                Write-Host "ğŸ’» CPU: $([math]::Round($cpuUsage, 2))% | ğŸ¯ Memory: $memoryUsage GB free"
            } catch {
                Write-Host "ğŸ’» System stats: N/A"
            }
            
            Write-Host "ğŸ˜´ Sleeping for $randomSeconds seconds..."
            Start-Sleep -Seconds $randomSeconds
            
            $counter++
        }
