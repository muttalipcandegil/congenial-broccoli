name: Setup RustDesk on Windows Runner choco 

on:
  workflow_dispatch:  # Manuel tetikleme iÃ§in

jobs:
  setup-rustdesk:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Chocolatey
      run: |
        # Chocolatey kur
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        Write-Host "âœ… Chocolatey kuruldu"

    - name: Generate secure random password
      id: generate-password
      run: |
        # GÃ¼venli rastgele ÅŸifre oluÅŸtur
        $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 12 | % {[char]$_})
        Write-Host "OluÅŸturulan ÅŸifre: $password"
        Write-Output "PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Install RustDesk via Chocolatey
      run: |
        # RustDesk'i Chocolatey ile kur
        choco install rustdesk -y --force --no-progress
        Write-Host "âœ… RustDesk kuruldu"

    - name: Set RustDesk password
      run: |
        # Åifreyi ayarla
        Start-Sleep -Seconds 3
        if (Test-Path "$env:ProgramFiles\RustDesk\rustdesk.exe") {
            & "$env:ProgramFiles\RustDesk\rustdesk.exe" --password "$env:PASSWORD"
            Write-Host "âœ… RustDesk ÅŸifresi ayarlandÄ±"
        } else {
            Write-Host "âŒ RustDesk.exe bulunamadÄ±"
            # Alternatif konumlarÄ± kontrol et
            $altPath = "${env:ProgramFiles(x86)}\RustDesk\rustdesk.exe"
            if (Test-Path $altPath) {
                & $altPath --password "$env:PASSWORD"
                Write-Host "âœ… RustDesk ÅŸifresi ayarlandÄ± (x86)"
            }
        }

    - name: Get RustDesk ID
      run: |
        Write-Host "RustDesk ID alÄ±nÄ±yor..."
        Start-Sleep -Seconds 3
        
        $rustdeskPaths = @(
            "$env:ProgramFiles\RustDesk\rustdesk.exe",
            "${env:ProgramFiles(x86)}\RustDesk\rustdesk.exe"
        )
        
        foreach ($path in $rustdeskPaths) {
            if (Test-Path $path) {
                Write-Host "RustDesk bulundu: $path"
                $id = & $path --get-id
                Write-Host "RustDesk ID: $id"
                Write-Output "RUSTDESK_ID=$id" | Out-File -FilePath $env:GITHUB_ENV -Append
                break
            }
        }
        
        if (-not $env:RUSTDESK_ID) {
            Write-Host "âš ï¸ RustDesk ID alÄ±namadÄ±, birkaÃ§ saniye beklenip tekrar denenecek..."
            Start-Sleep -Seconds 5
            # Tekrar dene
            foreach ($path in $rustdeskPaths) {
                if (Test-Path $path) {
                    $id = & $path --get-id
                    if ($id) {
                        Write-Host "RustDesk ID (2. deneme): $id"
                        Write-Output "RUSTDESK_ID=$id" | Out-File -FilePath $env:GITHUB_ENV -Append
                        break
                    }
                }
            }
        }

    - name: Start RustDesk
      run: |
        Write-Host "RustDesk baÅŸlatÄ±lÄ±yor..."
        
        # Servisi baÅŸlat
        Start-Service -Name "RustDesk" -ErrorAction SilentlyContinue
        
        # Process olarak da baÅŸlat
        if (Test-Path "$env:ProgramFiles\RustDesk\rustdesk.exe") {
            Start-Process -FilePath "$env:ProgramFiles\RustDesk\rustdesk.exe" -WindowStyle Hidden
        }
        
        Start-Sleep -Seconds 3
        Write-Host "âœ… RustDesk baÅŸlatÄ±ldÄ±"

    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "ğŸš€ RUSTDESK BAÄLANTI BÄ°LGÄ°LERÄ°"
        Write-Host "=========================================="
        Write-Host "ID: $env:RUSTDESK_ID"
        Write-Host "Password: $env:PASSWORD"
        Write-Host "=========================================="
        Write-Host ""

    - name: Verify Installation
      run: |
        Write-Host "Kurulum doÄŸrulanÄ±yor..."
        
        $success = $true
        
        # Process kontrolÃ¼
        $process = Get-Process rustdesk -ErrorAction SilentlyContinue
        if ($process) {
            Write-Host "âœ… RustDesk process Ã§alÄ±ÅŸÄ±yor"
        } else {
            Write-Host "âš ï¸ RustDesk process Ã§alÄ±ÅŸmÄ±yor"
            $success = $false
        }
        
        # ID kontrolÃ¼
        if ($env:RUSTDESK_ID) {
            Write-Host "âœ… RustDesk ID: $env:RUSTDESK_ID"
        } else {
            Write-Host "âŒ RustDesk ID alÄ±namadÄ±"
            $success = $false
        }
        
        if ($success) {
            Write-Host "ğŸ‰ RustDesk baÅŸarÄ±yla kuruldu!"
        } else {
            Write-Host "ğŸ’¥ Kurulumda bazÄ± sorunlar var"
        }
